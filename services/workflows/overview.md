# Workflows 解説

Google Cloud Workflows（ワークフロー）は、Google CloudのサービスやHTTPベースのAPIを連携させて、サーバーレスでワークフローを構築・実行できるフルマネージドなオーケストレーションサービスです。複雑な処理フローを視覚的に定義し、信頼性の高いアプリケーションや自動化プロセス、データ処理パイプラインなどを構築するのに役立ちます。

### 主な機能

* **多様なサービス連携:** Cloud Functions、Cloud Run、BigQuery、Cloud StorageなどのGoogle Cloudサービスはもちろん、外部のHTTP/HTTPS APIもステップとして組み込めます。これにより、様々なシステムやサービスを統合した自動化が実現可能です。
* **柔軟な制御フロー:** YAMLまたはJSONでワークフローを定義し、順次処理、並行処理、条件分岐（`if`/`else`）、繰り返し処理（`for`）、例外処理（`try`/`except`）、遅延（`wait`）など、複雑なロジックを記述できます。
* **信頼性とフォールトトレランス:** 各ステップの実行状態を自動的に保存（チェックポイント）し、エラー発生時には自動リトライやカスタムエラーハンドリングを設定できます。これにより、一時的な障害にも強い、信頼性の高いワークフローを構築できます。最長1年間の実行が可能です。
* **サーバーレスと自動スケーリング:** インフラの管理は不要で、需要に応じて自動的にスケールします。ワークフローが実行されていない間の料金は発生しません。
* **可視化とモニタリング:** 定義したワークフローはフロー図として視覚的に表示でき、実行状況やログをGoogle CloudコンソールやCloud Loggingでモニタリングできます。
* **コネクタ:** Google Cloudの各種サービスとの連携を容易にするためのコネクタが用意されており、認証やリクエストのフォーマットなどを意識せずに利用できます。
* **IAMによるアクセス制御:** Google CloudのIdentity and Access Management (IAM) と統合されており、ワークフローや関連リソースへのアクセスをきめ細かく制御できます。

### 料金

Workflowsの料金は、主に以下の2つの要素に基づいて計算されます。

* **内部ステップ実行数:** ワークフロー内でGoogle Cloudサービスや制御フローのステップが実行された回数。
* **外部HTTPコール数:** ワークフローから外部HTTP/HTTPS APIを呼び出した回数。

無料枠として、毎月5,000ステップの内部ステップ実行と2,000回の外部HTTPコールが提供されます。これを超過した分について、以下の料金が発生します（2025年5月3日現在）。

* **内部ステップ:** 5,001～1億ステップ：1,000ステップあたり $0.01
* **外部HTTPコール:** 2,001～1億コール：1,000コールあたり $0.025

1億ステップ、1億コールを超過する場合は、別途見積もりが必要です。

**参考:** [Workflows pricing - Google Cloud](https://cloud.google.com/workflows/pricing?hl=ja)

### 類似サービスとの比較

主な類似サービスとしては、AWS Step Functionsが挙げられます。

| 機能             | Google Cloud Workflows                                 | AWS Step Functions                                     |
| ---------------- | ------------------------------------------------------ | ------------------------------------------------------ |
| 構文             | YAMLまたはJSON                                         | JSON (ツールでYAMLも利用可能)                           |
| 制御フロー       | 命令型のステップ実行                                   | 状態遷移                                               |
| ワーカー         | HTTPリクエスト、コネクタ                               | リソースARN、HTTPタスク                               |
| 信頼性           | Catch/Retry                                            | Catch/Retry                                            |
| 並行処理         | サポート                                               | サポート                                               |
| 状態管理         | ワークフロー変数                                       | 状態遷移時のJSONデータ                                 |
| 認証             | IAM                                                    | IAM                                                    |
| ユーザーエクスペリエンス | Google Cloudコンソール、CLI、SDK、IaC                 | Workflow Studio、CLI、SDK、IaC                         |
| 料金             | ステップ実行数、外部HTTPコール数に基づく従量課金       | 状態遷移数、実行時間に基づく従量課金                   |

**主な違い:**

* **制御フロー:** Workflowsはステップを順に記述していく命令型であるのに対し、Step Functionsは状態と遷移を定義するステートマシン型です。
* **状態管理:** Workflowsは変数で状態を管理しますが、Step Functionsは状態遷移ごとにJSONデータを受け渡します。
* **料金体系:** Workflowsはステップ実行数と外部HTTPコール数、Step Functionsは状態遷移数と実行時間に基づいて課金されます。

**参考:** [Migrate from AWS Step Functions to Workflows - Google Cloud](https://cloud.google.com/workflows/docs/migrate-from-step-functions?hl=ja)

### 利用シナリオ

Workflowsは、以下のような様々なシナリオで活用できます。

* **サービスオーケストレーション:** 複数のマイクロサービスやAPIを連携させて、複雑なビジネスロジックを自動化します。
    * 例：新規顧客登録時に、顧客管理システムへの登録、メール送信、CRMへのデータ連携などを順次実行する。
* **バッチ処理:** 大量のデータに対する処理を効率的に実行します。
    * 例：毎日バッチ処理で顧客データを集計し、レポートを生成してCloud Storageに保存する。
* **データパイプライン:** データの抽出、変換、ロード（ETL）処理を自動化します。
    * 例：Cloud StorageにアップロードされたログファイルをBigQueryにロードし、分析用のテーブルを作成する。
* **ITプロセスの自動化:** インフラのプロビジョニング、アプリケーションのデプロイ、システムメンテナンスなどの運用タスクを自動化します。
    * 例：新しい仮想マシンを起動し、必要なソフトウェアをインストールして構成する。
* **イベント駆動型処理:** Cloud StorageへのファイルアップロードやPub/Subのメッセージ受信などをトリガーとして、特定の処理を実行します。
    * 例：Cloud Storageに新しい画像ファイルがアップロードされたら、Cloud Vision APIで画像解析を行い、結果をFirestoreに保存する。
* **ビジネスプロセスの自動化:** 承認ワークフローや注文処理など、ビジネスにおける一連のステップを自動化します。
    * 例：経費申請があった際に、承認者の承認を得て、会計システムに連携する。

**参考:** [Workflows overview - Google Cloud](https://cloud.google.com/workflows/docs/overview?hl=ja)

Workflowsは、サーバーレスで柔軟かつ信頼性の高いワークフローを構築できる強力なツールです。様々なGoogle Cloudサービスや外部APIとの連携を通じて、ビジネスの自動化や効率化に貢献します。

## 参考

- https://cloud.google.com/workflows/docs/overview?hl=ja
- https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/workflows_workflow
