# Cloud Tasks 解説

### Cloud Tasksの主な機能

Cloud Tasksは、アプリケーションから非同期に実行されるタスクの作成、管理、配信を行うためのフルマネージド型のサービスです。主な機能は以下の通りです。

* **信頼性の高いタスク配信:** Cloud Tasksは、少なくとも1回はタスクが実行されることを保証します。一時的な障害が発生した場合でも、自動的に再試行が行われます。
* **スケーラビリティ:** タスクの量に応じて自動的にスケールします。大量のタスクを処理する必要がある場合でも、インフラの管理を意識する必要はありません。
* **柔軟な実行ターゲット:** App Engine、Cloud Functions、Cloud RunなどのHTTPエンドポイントを持つ任意のサービスをタスクの実行ターゲットにできます。
* **遅延とスケジュール設定:** タスクの実行を特定の日時に遅らせたり、定期的に実行するようにスケジュールしたりできます。
* **優先度制御:** タスクに優先度を設定することで、重要なタスクを優先的に処理できます。
* **HTTPメソッドのサポート:** GET、POST、PUT、DELETEなどのHTTPメソッドをサポートしており、多様なAPIとの連携が可能です。
* **認証と承認:** IAM（Identity and Access Management）と連携し、タスクの作成や実行に対するアクセス制御が可能です。
* **モニタリングとロギング:** Cloud MonitoringやCloud Loggingと統合されており、タスクの実行状況やエラーを容易に監視できます。

### 料金

Cloud Tasksの料金は、主に以下の要素に基づいて計算されます。

* **タスクの作成オペレーション:** タスクを作成するたびに料金が発生します。最初の100万オペレーションは無料枠があります。
* **タスクの配信試行:** タスクの実行を試みるたびに料金が発生します。成功・失敗に関わらず、試行回数に応じて課金されます。最初の10万配信試行は無料枠があります。

詳細な料金体系については、[Google CloudのCloud Tasksの料金ページ](https://cloud.google.com/tasks/pricing?hl=ja)をご確認ください。

### 類似サービスとの比較

Cloud Tasksと類似するサービスとして、以下のようなものが挙げられます。

* **Cloud Pub/Sub:** メッセージキューイングサービスであり、疎結合なマイクロサービス間の非同期通信に適しています。Cloud Tasksは、特定のHTTPエンドポイントへのタスク実行を保証する点に違いがあります。
* **Cloud Scheduler:** Cronジョブのように、定期的なタスクのスケジュール実行に特化したサービスです。Cloud Tasksは、より複雑なワークフローや遅延実行、再試行ポリシーなどをサポートしています。
* **App Engine Task Queues (Legacy):** App Engine環境に特化したタスクキューサービスです。Cloud Tasksはより汎用性が高く、App Engine以外の環境でも利用できます。

| 機能             | Cloud Tasks                               | Cloud Pub/Sub                         | Cloud Scheduler                         | App Engine Task Queues (Legacy) |
| ---------------- | ----------------------------------------- | ------------------------------------- | --------------------------------------- | --------------------------------- |
| 主な目的         | 信頼性の高い非同期タスク実行と管理        | 疎結合な非同期メッセージング          | 定期的なジョブのスケジュール実行        | App Engine内での非同期タスク実行    |
| 実行ターゲット   | HTTPエンドポイント（App Engine, Cloud Functions, Cloud Runなど） | サブスクライバー（HTTPエンドポイントなど） | HTTPエンドポイント、Pub/Subトピックなど | App Engineハンドラー              |
| 信頼性           | 少なくとも1回実行保証、再試行ポリシー    | 少なくとも1回配信（保証は設定による） | 少なくとも1回実行保証                  | 少なくとも1回実行保証、再試行ポリシー |
| スケール         | 自動スケーリング                            | 自動スケーリング                        | スケジュールされた時間に実行            | App Engineインスタンスに依存       |
| 遅延/スケジュール | 対応                                      | 遅延配信は限定的                      | 対応                                    | 対応                                |
| 優先度制御       | 対応                                      | なし                                  | なし                                    | 対応                                |
| 汎用性           | 高い                                      | 高い                                  | 特定用途向け                            | App Engineに限定                  |

### 利用シナリオ

Cloud Tasksは、以下のような様々なシナリオで活用できます。

* **バックグラウンド処理:** ユーザーのリクエスト処理中に時間のかかる処理（画像の最適化、動画のエンコード、バッチ処理など）を非同期に実行する。
* **メール送信:** ユーザー登録や注文確認などのメール送信を、メインの処理から切り離して実行する。
* **Webhookの呼び出し:** イベント発生時に、外部のサービスやAPIに対してHTTPリクエストを送信する。
* **定期的なレポート生成:** 毎日、毎週など、決まった時間に集計処理を実行し、レポートを作成する。
* **リトライ処理:** 外部APIの呼び出しが一時的に失敗した場合に、指数バックオフなどの戦略を用いて再試行する。
* **ワークフローのオーケストレーション:** 複数の処理を順番に実行したり、条件分岐させたりする複雑なワークフローを構築する。

これらの情報が、Cloud Tasksのご理解の一助となれば幸いです。

## 参考

- https://cloud.google.com/tasks/docs/dual-overview?hl=ja
- https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/cloud_tasks_queue
