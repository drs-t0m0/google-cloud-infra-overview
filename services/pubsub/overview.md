# Google Cloud Pub/Sub 解説

## Google Cloud Pub/Sub とは

Google Cloud Pub/Sub は、アプリケーションやサービス間でメッセージを送受信するための、スケーラブルで信頼性の高い非同期メッセージングサービスです。パブリッシャー（メッセージを送信する側）とサブスクライバー（メッセージを受信する側）を分離することで、疎結合なシステムを構築し、柔軟性と耐障害性を高めることができます。

## 主な機能

* **パブリッシュ/サブスクライブモデル:** メッセージを特定のトピックにパブリッシュし、サブスクライバーは関心のあるトピックをサブスクライブしてメッセージを受信します。
* **非同期通信:** パブリッシャーはメッセージの送信後すぐに処理を続行でき、サブスクライバーはメッセージが利用可能になったときに処理を行います。これにより、システムの応答性が向上します。
* **スケーラビリティ:** メッセージの量やサブスクライバーの数に応じて自動的にスケールアップ/ダウンします。
* **信頼性:** メッセージは永続的に保存され、少なくとも1回は配信されることが保証されます。配信に失敗した場合は、再配信やデッドレターキューへの移動などの機能があります。
* **グローバル配信:** 複数のリージョンにまたがるパブリッシャーとサブスクライバー間でメッセージをやり取りできます。
* **メッセージフィルタリング:** サブスクライバーは、メッセージの属性に基づいて受信するメッセージをフィルタリングできます。
* **メッセージの順序付け (オプション):** トピックごとにメッセージの順序配信を保証するオプションがあります。
* **多様な配信方法:**
    * **Push:** Pub/Subサービスがサブスクライバーのエンドポイント（Webhookなど）にメッセージを自動的に送信します。
    * **Pull:** サブスクライバーがPub/Subサービスからメッセージを明示的に取得します。
* **他の Google Cloud サービスとの統合:** Dataflow、BigQuery、Cloud Functions など、様々な Google Cloud サービスと容易に連携できます。
* **セキュリティ:** IAMによるアクセス制御、保存時および転送時の暗号化など、堅牢なセキュリティ機能を提供します。

## 料金

Google Cloud Pub/Sub の料金は、主に以下の要素に基づいて計算されます。

* **メッセージングスループット:** パブリッシュおよび配信されたデータ量（GB単位）。最初の 10 GB/月は無料です。超過分はリージョンによって異なりますが、通常 TB あたり $40 USD 程度です。
* **メッセージストレージ (Seek/Replay機能利用時):** スナップショットや保持された確認済みメッセージの保存容量（GB/月）。
* **アウトバウンドデータ転送 (リージョン外への配信):** 異なるリージョンにメッセージを配信する場合に発生する可能性があります。

**無料枠:** 毎月、メッセージの取り込みまたは配信に利用できる 10 GB の無料クレジットがあります。

より詳細な料金体系や料金例については、[Pub/Sub の料金 - Google Cloud](https://cloud.google.com/pubsub/pricing?hl=ja) をご確認ください。

## 類似サービスとの比較

Google Cloud Pub/Sub と類似のメッセージングサービスとしては、以下のようなものがあります。

* **Apache Kafka:** 高スループットなストリーム処理に強く、オンプレミスや他のクラウド環境でも利用可能です。Pub/Subと比較して、より多くの設定や運用管理が必要になる場合があります。
* **Amazon SNS (Simple Notification Service) / SQS (Simple Queue Service):** AWSのメッセージングサービスです。SNSはPub/Subと同様のパブリッシュ/サブスクライブモデル、SQSはメッセージキューイングサービスです。
* **Azure Service Bus:** Microsoft Azureのメッセージングサービスで、キューイング、パブリッシュ/サブスクライブ、リレーなどの機能を提供します。
* **RabbitMQ:** オープンソースのメッセージブローカーで、柔軟なルーティング機能が特徴です。運用管理はユーザーが行う必要があります。

**Pub/Sub の主な利点:**

* **完全マネージド:** インフラの管理が不要で、スケーリングも自動的に行われます。
* **グローバルな可用性:** 複数のリージョンで利用可能で、リージョン間のメッセージングも容易です。
* **Google Cloud エコシステムとの親和性:** 他の Google Cloud サービスとの連携がスムーズです。
* **シンプルな操作性:** 比較的容易に利用を開始できます。

**Pub/Sub を選択する際の考慮事項:**

* **Google Cloud 環境への依存:** Google Cloud のインフラストラクチャ上で動作します。
* **高度なストリーム処理機能:** Kafkaほど高度なストリーム処理機能は備えていません（Dataflowなどの他のサービスと組み合わせることで実現可能です）。

## 利用シナリオ

Google Cloud Pub/Sub は、以下のような様々なシナリオで活用できます。

* **イベント駆動型アーキテクチャ (EDA):** マイクロサービス間の非同期通信や、システム内のイベント通知に利用し、疎結合でスケーラブルなシステムを構築します。
* **リアルタイムデータ処理:** IoTデバイスからのデータ、Webサイトのクリックストリーム、金融取引データなどをリアルタイムに収集・配信し、分析や処理を行います（Dataflowとの連携など）。
* **アプリケーション統合:** 異なるアプリケーションやサービス間でデータを安全かつ確実にやり取りします。
* **通知システム:** ユーザーへのアラート通知、ジョブの完了通知などを配信します。
* **ログ集約:** 複数のソースからのログデータを一元的に収集し、処理・分析基盤へ配信します。
* **キャッシュ無効化:** データベースの更新イベントなどをPub/Subで通知し、キャッシュを即座に無効化します。
* **バッチ処理のトリガー:** ある処理が完了したことをPub/Subで通知し、次のバッチ処理をトリガーします。

これらの情報が、Google Cloud Pub/Sub の理解に役立てば幸いです。

## 参考

- https://cloud.google.com/pubsub/docs/overview?hl=ja
- https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/pubsub_topic
